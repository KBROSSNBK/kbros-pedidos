<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üòé KBROS üòé</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
 #detalleItems button {
    margin: 4px;
    padding: 6px 10px;
    font-size: 1em;
    border: none;
    border-radius: 6px;
    background: #000;
    color: #fff;
    cursor: pointer;
    transition: background 0.2s;
  }
  #detalleItems button:hover {
    background: #333;
  }
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0; padding: 0; background: #fff; color: #000;
    }
    header {
      background: #000; color: #fff; padding: 1em;
      text-align: center; font-size: 1.6em; letter-spacing: 1px;
    }
    .boton-hundido {
  transform: scale(0.95);
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
  transition: transform 0.1s, box-shadow 0.1s;
}

    .top-buttons {
      display: flex; justify-content: center; align-items: center;
      gap: 0.6em; flex-wrap: wrap; padding: 1em;
    }
    .top-buttons button {
      font-size: 1.1em; padding: 0.6em 1em;
      border-radius: 10px; background: #000; color: #fff;
      border: none; cursor: pointer;
    }
    .categoria-btn {
      padding: 1em; font-size: 1.2em; font-weight: bold;
      background: #f5f5f5; border-top: 2px solid #000;
      cursor: pointer; transition: background 0.3s ease;
    }
    .productos {
      display: none; flex-wrap: wrap; justify-content: center;
      padding: 0.5em 1em 1em 1em; animation: fadeIn 0.3s ease;
    }
button.clickeado {
  background-color: #4caf50 !important;
  color: white !important;
}

.contador.coloreado {
  animation: cambiarColor 0.8s ease;
}

@keyframes cambiarColor {
  0% { background-color: #000; }
  50% { background-color: var(--color-random); }
  100% { background-color: #000; }
}


    @keyframes fadeIn {
      from {opacity: 0;} to {opacity: 1;}
    }
    .producto {
      background: #f9f9f9; border: 1px solid #ccc;
      border-radius: 10px; margin: 0.4em; padding: 1em;
      width: 46%; box-sizing: border-box; cursor: pointer;
      font-size: 0.95em; text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: transform 0.2s, background 0.2s;
    }
    .producto:active { transform: scale(0.95); background: #ddd; }
    .carrito-fijo {
      position: fixed; bottom: 0; width: 100%;
      background: #fff; border-top: 2px solid #000;
      display: flex; justify-content: space-between;
      padding: 1em; box-shadow: 0 -2px 5px rgba(0,0,0,0.2);
      z-index: 10;
    }
    .carrito-fijo button {
      flex: 1; margin: 0 0.5em; padding: 1em;
      font-size: 1em; border: none; border-radius: 8px;
      cursor: pointer; transition: transform 0.2s;
    }
    .carrito-fijo button:active { transform: scale(0.97); }
    .limpiar { background: #ff5c5c; color: white; }
    .pedir {
      background: #4caf50; color: white; animation: none;
    }
    .pedir.animar {
      animation: bounce 0.7s ease infinite;
    }
    .total {
      font-weight: bold; align-self: center; margin: 0 0.5em;
    }
    .contador {
      font-size: 1.1em; font-weight: bold; display: flex; align-items: center;
      gap: 5px; background: #000; color: #fff; padding: 0.5em 1em;
      border-radius: 10px;
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-4px); }
    }
  </style>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

</head>
<body>
  <header>‚úå KBROS ‚úå</header>
  <div class="top-buttons">
    <button onclick="feedbackBoton(this); toggleMenu()">MEN√ö üòã</button>
    <div class="contador" onclick="feedbackBoton(this); mostrarDetalleCarrito(true)">üõí <span id="contadorCarrito">0</span></div>
    <div class="contador" id="botonLike" onclick="sumarLike()">‚ù§ <span id="contadorLikes">0</span></div>
    <div class="contador">üëÅ <span id="contadorUsuarios">0</span></div>

  </div>
  <div id="menu"></div>

  <div id="carrito-detalle" style="display:none; padding:1em; background:#f8f8f8; border-top:2px solid #000;">
  <h3>üõí Detalle del pedido</h3>
  <ul id="detalleItems" style="list-style:none; padding-left:0;"></ul>
</div>


<div class="carrito-fijo">
    <button class="limpiar" onclick="limpiarCarrito()">LIMPIAR</button>
    <div class="total" id="total">üí≤0</div>
    <button class="pedir" id="btnPedir" onclick="enviarPedido()">PEDIR</button>
  </div>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDR-LnHsJ54kj-5vRzB3NoK-EB-ELD9xQs",
      authDomain: "kbros-web.firebaseapp.com",
      databaseURL: "https://kbros-web-default-rtdb.firebaseio.com",
      projectId: "kbros-web",
      storageBucket: "kbros-web.firebasestorage.com",
      messagingSenderId: "281753184526",
      appId: "1:281753184526:web:c6e824fefd7b261a428f5f",
      measurementId: "G-YRHHRCGKK0"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let carrito = [];
    let menuVisible = false;

    function toggleMenu() {
      const menu = document.getElementById("menu");
      menu.style.display = menuVisible ? "none" : "block";
      menuVisible = !menuVisible;
    }
function feedbackBoton(elemento) {
  if (!elemento) return;
  elemento.classList.add("clickeado");
  setTimeout(() => elemento.classList.remove("clickeado"), 200);
}

    function agregar(nombre, precio) {
      const item = carrito.find(p => p.nombre === nombre);
      if (item) item.cantidad++;
      else carrito.push({ nombre, precio, cantidad: 1 });
      renderTotal();
    }

    function renderTotal() {
      const total = carrito.reduce((sum, p) => sum + p.precio * p.cantidad, 0);
      document.getElementById("total").textContent = "üí≤" + total;
      document.getElementById("btnPedir").classList.toggle("animar", total > 0);
      document.getElementById("contadorCarrito").textContent = carrito.reduce((a, b) => a + b.cantidad, 0);
      mostrarDetalleCarrito();
    }
    
function mostrarDetalleCarrito(forceShow = false) {
  const lista = document.getElementById("detalleItems");
  const panel = document.getElementById("carrito-detalle");
  lista.innerHTML = '';

  carrito.forEach((p, i) => {
    lista.innerHTML += `
      <li>
        ${p.nombre} x${p.cantidad} = üí≤${p.precio * p.cantidad} <br>
        <button onclick="modificarCantidad(${i}, -1)">‚ûñ</button>
        <button onclick="modificarCantidad(${i}, 1)">‚ûï</button>
      </li>
    `;
  });

  // solo mostrar el panel si es forzado o ya est√° visible
  if (forceShow || panel.style.display === "block") {
    panel.style.display = carrito.length > 0 ? "block" : "none";
  }
}

    
function modificarCantidad(index, cambio) {
  carrito[index].cantidad += cambio;

  if (carrito[index].cantidad <= 0) {
    carrito.splice(index, 1); // elimina el producto
  }

  renderTotal(); // esto vuelve a mostrar todo actualizado
}


    function limpiarCarrito() {
      carrito = [];
      renderTotal();
    }

async function enviarPedido() {
  if (carrito.length === 0) return alert("Primero a√±ade productos al carrito.");

  const modo = await elegirModoEntrega();
  if (!modo) return;

  let costoDelivery = 0;
  let ubicacionCliente = "";
  let direccionTexto = "";
  if (modo === "DELIVERY") {
    try {
      const coords = await obtenerUbicacionGPS();
      ubicacionCliente = `${coords.lat},${coords.lng}`;
      const distanciaKM = await calcularDistanciaAuto(coords.lat, coords.lng);
      const kmRedondeado = Math.round(distanciaKM);
      costoDelivery = kmRedondeado <= 1 ? 1500 : 1500 + (kmRedondeado - 1) * 200;
      direccionTexto = `Ubicaci√≥n GPS: https://www.google.com/maps?q=${coords.lat},${coords.lng} (${kmRedondeado} km aprox)`;
    } catch (err) {
      alert("No se pudo obtener tu ubicaci√≥n. Intenta permitir el acceso al GPS.");
      return;
    }
  }

  const nombre = prompt("¬øCu√°l es tu nombre?");
  if (!nombre) return;

  const telefono = prompt("Ingresa tu n√∫mero de contacto (9 d√≠gitos sin +56):");
  if (!telefono || !/^\d{9}$/.test(telefono)) {
    alert("N√∫mero inv√°lido. Debe tener exactamente 9 d√≠gitos.");
    return;
  }

  const totalPedido = carrito.reduce((sum, p) => sum + p.precio * p.cantidad, 0);
  const totalFinal = totalPedido + costoDelivery;

  let mensaje = `Soy ${nombre}\nQuiero - *${modo}*\nContaco: +56${telefono}\n\n*Detalle del pedido:*\n`;
  carrito.forEach(p => {
    mensaje += `‚Ä¢ ${p.nombre} x${p.cantidad} = $${p.precio * p.cantidad}\n`;
  });

  if (modo === "DELIVERY") {
    mensaje += `\n*Delivery:* $${costoDelivery}\n${direccionTexto}`;
  }

  mensaje += `\n\n*TOTAL:* $${totalFinal}`;

  const wsp = `https://wa.me/56956446048?text=${encodeURIComponent(mensaje)}`;
  window.open(wsp, "_blank");

  carrito = [];
  renderTotal();
  document.getElementById("carrito-detalle").style.display = "none";
}
function elegirModoEntrega() {
  return new Promise(resolve => {
    const cont = document.createElement("div");
    cont.style.position = "fixed";
    cont.style.top = 0;
    cont.style.left = 0;
    cont.style.width = "100%";
    cont.style.height = "100%";
    cont.style.background = "rgba(0,0,0,0.8)";
    cont.style.display = "flex";
    cont.style.flexDirection = "column";
    cont.style.justifyContent = "center";
    cont.style.alignItems = "center";
    cont.style.zIndex = 1000;
    cont.innerHTML = `
      <div style="background:#fff;padding:2em;border-radius:10px;text-align:center;max-width:300px;">
        <h3>¬øC√≥mo quieres recibir tu pedido?</h3>
        <label><input type="radio" name="modo" value="DELIVERY"> üöö DELIVERY</label><br><br>
        <label><input type="radio" name="modo" value="RETIRO"> üèÉ‚Äç‚ôÇÔ∏è RETIRO EN LOCAL</label><br><br>
        <button style="margin-top:1em;padding:0.6em 1.2em;font-weight:bold;">CONFIRMAR</button>
      </div>
    `;
    document.body.appendChild(cont);

    cont.querySelector("button").onclick = () => {
      const seleccionado = cont.querySelector("input[name='modo']:checked");
      const valor = seleccionado ? seleccionado.value : null;
      if (!valor) {
        alert("Debes seleccionar una opci√≥n.");
        return;
      }
      document.body.removeChild(cont);
      resolve(valor);
    };
  });
}

function obtenerUbicacionGPS() {
  return new Promise((resolve, reject) => {
    const overlay = document.createElement("div");
    overlay.style.position = "fixed";
    overlay.style.top = 0;
    overlay.style.left = 0;
    overlay.style.width = "100%";
    overlay.style.height = "100%";
    overlay.style.background = "rgba(0,0,0,0.8)";
    overlay.style.zIndex = 9999;
    overlay.innerHTML = `
      <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:1em;border-radius:10px;width:90%;max-width:500px;">
        <h3 style="margin:0 0 10px 0;">üìç Selecciona d√≥nde quieres tu pedido:</h3>
        <div id="mapa" style="height:300px;border-radius:8px;"></div>
        <button id="confirmarUbicacion" style="margin-top:10px;padding:10px 15px;font-weight:bold;">CONFIRMAR UBICACI√ìN</button>
      </div>
    `;
    document.body.appendChild(overlay);

    const ubicacionKBROS = [-33.6067, -70.6861]; // Direcci√≥n fija del local
const mapa = L.map("mapa").setView(ubicacionKBROS, 16);

// üî• A√±ade marcador del local
L.marker(ubicacionKBROS).addTo(mapa).bindPopup("üî∞KBROSüî∞").openPopup();

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
    }).addTo(mapa);

    let marcador = null;
    let coordenadas = null;

    mapa.on("click", function (e) {
      if (marcador) marcador.remove();
      marcador = L.marker(e.latlng).addTo(mapa);
      coordenadas = e.latlng;
    });

    // Centrar en ubicaci√≥n del cliente si se permite
    mapa.locate({ setView: true, maxZoom: 17 });

    mapa.on("locationfound", function (e) {
      // C√≠rculo de referencia visual
      L.circle(e.latlng, { radius: 50, color: "#2c7" }).addTo(mapa);
    });

    mapa.on("locationerror", function () {
      console.log("No se pudo obtener la ubicaci√≥n del cliente autom√°ticamente.");
    });

    document.getElementById("confirmarUbicacion").onclick = () => {
      if (!coordenadas) {
        alert("Haz clic en el mapa para seleccionar tu ubicaci√≥n.");
        return;
      }
      document.body.removeChild(overlay);
      resolve({ lat: coordenadas.lat, lng: coordenadas.lng });
    };
  });
}



async function calcularDistanciaAuto(latCliente, lngCliente) {
  const local = { lat: -33.60675364336594, lng: -70.68617400931403 }; // Cambia si la ubicaci√≥n del local cambia
  const respuesta = await fetch(`https://router.project-osrm.org/route/v1/driving/${lngCliente},${latCliente};${local.lng},${local.lat}?overview=false`);
  const data = await respuesta.json();
  const metros = data.routes[0].distance;
  return metros / 1000; // km
}


function sumarLike() {
  const el = document.getElementById("botonLike");
  if (el) {
    // Efecto visual del clic (hundido)
    el.classList.add("boton-hundido");
    setTimeout(() => el.classList.remove("boton-hundido"), 120);

    // Color aleatorio
    const randomColor = "#" + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
    el.style.setProperty("--color-random", randomColor);
    el.style.backgroundColor = randomColor;

    db.ref("colorLike").set(randomColor);
  }

  db.ref("likes").transaction(current => (current || 0) + 1);
}

    function renderMenu() {
      const categorias = {
      "COMPLETOS üå≠": [
        ["HOT DOG - CHICO", 1200], ["HOT DOG - GRANDE", 1800],
        ["ITALIANO - CHICO", 2000], ["ITALIANO - GRANDE", 3000],
        ["COMPLETO - CHICO", 1800], ["COMPLETO - GRANDE", 2400],
        ["TOCOMPLE - CHICO", 2500], ["TOCOMPLE - GRANDE", 3500],
        ["DINAMICO - CHICO", 2500], ["DINAMICO - GRANDE", 3500],
        ["CHAMO - CHICO", 2000], ["CHAMO - GRANDE", 3000]],
      "AS üå≠": [
        ["AS - CHICO", 2200], ["AS - GRANDE", 2800],
        ["AS - ITALIANO - CHICO", 3000], ["AS - ITALIANO - GRANDE", 4000],
        ["AS - COMPLETO - CHICO", 2800], ["AS - COMPLETO - GRANDE", 3400],
        ["AS - TOCOMPLE - CHICO", 3500], ["AS - TOCOMPLE - GRANDE", 4500],
        ["AS - DINAMICO - CHICO", 3500], ["AS - DINAMICO - GRANDE", 4500],
        ["AS - QUESO - CHICO", 3000], ["AS - QUESO - GRANDE", 4000]
      ],
      "HAMBURGUESAS üçî": [["HAMBURGUESA CLASICA",4500],["HAMBURGUESA ITALIANA",4500],["HAMBURGUESA AMERICANA",4500],["CHEDDAR BACON",5500],["CON PAPAS",1000],["PAPAS + SALSA CHEDDAR",1500],["HAMBURGUESA + CHEDDAR",1000]],
      "MECHADAS üçî": [["MECHA-LUCO",5000],["MECHADA ITALIANO",5000],["MECHADA CHACARERO",5000],["MECHAITO",5500],["CON PAPAS",1000],["PAPAS + SALSA CHEDDAR",1500]],
      "CHURRASCOS üçî": [["CHURRAS-LUCO",4500],["CHURRASCO ITALIANO",4500],["CHURRASCO CHACARERO",4500],["CHURRASQUITO",5000],["CON PAPAS",1000],["PAPAS + SALSA CHEDDAR",1500]],
      "FAJITAS üåØ": [["FAJITA PIOLA",4500],["FAJITA KBROS",5000],["FAJITA A TU PINTA",5000]],
      "PAPAS FRITAS üçü": [["PAPAS ALTOKE CHICA",2000],["PAPAS ALTOKE GRANDE",3500],["SALCHIPAPAS",4000],["PAPAS PIOLA",4000],["PAPAS PULENTAS",4500],["PAPAS GRINGAS",4800],["PAPAS CHIDAS",4500],["PAPAS SUPREMAS",5000]],
      "DORILOKOS ü§™": [["DORILOKOSü§©",4500]],
      "EMPANADAS ü•ü": [["EMPANADAS DE QUESO X5",2000]],
      "BEBESTIBLES ü•§": [["BEBIDA LATA",1200],["JUGO",1500],["AGUA",1000]],
    };

      const cont = document.getElementById("menu");
      cont.innerHTML = '';
      let active = null;

      for (const cat in categorias) {
        const btn = document.createElement("div");
        btn.className = "categoria-btn";
        btn.textContent = cat;
        const box = document.createElement("div");
        box.className = "productos";

        categorias[cat].forEach(([nombre, precio]) => {
          const prod = document.createElement("div");
          prod.className = "producto";
          prod.textContent = `${nombre} üí≤${precio}`;
          prod.onclick = () => agregar(nombre, precio);
          box.appendChild(prod);
        });

        btn.onclick = () => {
          document.querySelectorAll(".productos").forEach(p => p.style.display = "none");
          if (active === box) { box.style.display = "none"; active = null; }
          else { box.style.display = "flex"; active = box; }
        };

        cont.appendChild(btn);
        cont.appendChild(box);
      }
    }

function syncFirebase() {
  db.ref("likes").on("value", snapshot => {
    document.getElementById("contadorLikes").textContent = snapshot.val() || 0;
  });

  const userRef = db.ref("usuarios").push(true);
  userRef.onDisconnect().remove();

  db.ref("usuarios").on("value", snap => {
    const total = snap.numChildren();
    document.getElementById("contadorUsuarios").textContent = total;
  });

  db.ref("colorLike").on("value", snap => {
    const color = snap.val();
    const likeBtn = document.getElementById("botonLike");
    if (color && likeBtn) {
      likeBtn.style.backgroundColor = color;
    }
  });
}


    renderMenu();
    renderTotal();
    syncFirebase();
  </script>
</body>
</html>
